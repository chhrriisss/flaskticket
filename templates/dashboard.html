{% extends "base.html" %}

{% block title %}Dashboard - Ticketing Tool{% endblock %}

{% block content %}
<!-- SEARCH PANEL - NOW FIRST -->
<div class="card" style="box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: none; border-radius: 8px; margin-bottom: 24px;">
    <div class="card-header" style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; padding: 12px 20px; border-radius: 8px 8px 0 0; border: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div>
                    <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: white; letter-spacing: -0.3px;">Search & Filter Packages</h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body" id="searchPanelBody" style="padding: 20px; background: linear-gradient(135deg, #f8fcff 0%, #ffffff 100%);">
        <!-- Global Text Search -->
        <div style="margin-bottom: 16px;">
            <label style="font-weight: 600; font-size: 14px; color: #2c3e50; margin-bottom: 6px; display: block;">
                Quick Search
            </label>
            <div style="position: relative;">
                <input type="text" 
                       id="searchText" 
                       placeholder="Search by Package ID, Customer, or any field..." 
                       style="width: 100%; padding: 10px 16px 10px 40px; font-size: 13px; border: 2px solid #e8ecef; border-radius: 8px; background: white; transition: all 0.2s ease;"
                       onfocus="this.style.borderColor='#17a2b8'; this.style.boxShadow='0 0 0 4px rgba(23,162,184,0.1)'"
                       onblur="this.style.borderColor='#e8ecef'; this.style.boxShadow='none'"
                       onkeyup="if(event.key === 'Enter') performSearch()">
            </div>
        </div>

        <!-- Advanced Filters -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 12px;">
            <!-- Assigned Users Filter (Admin only) -->
            {% if session.role == 'admin' %}
            <div>
                <label style="font-weight: 600; font-size: 13px; color: #2c3e50; margin-bottom: 8px; display: block;">
                     Assigned Users
                </label>
                <select id="userFilter" 
                        multiple 
                        style="width: 100%; height: 120px; padding: 8px; font-size: 13px; border: 2px solid #e8ecef; border-radius: 8px; background: white; cursor: pointer;"
                        onfocus="this.style.borderColor='#17a2b8'"
                        onblur="this.style.borderColor='#e8ecef'">
                    {% for username, user_data in users.items() %}
                    {% if username != 'admin' %}
                    <option value="{{ username }}">{{ user_data.name }} (@{{ username }})</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <small style="color: #6c757d; font-size: 11px; display: block; margin-top: 6px;">Hold Ctrl/Cmd to select multiple</small>
            </div>
            {% endif %}

            <!-- Custom Field Filters -->
            {% for field_name, field_config in config.fields.items() %}
            {% if field_config.type == 'dropdown' and field_name not in ['STATUS', 'status'] %}
            <div>
                <label style="font-weight: 600; font-size: 13px; color: #2c3e50; margin-bottom: 8px; display: block;">
                    {{ field_config.label }}
                </label>
                <select id="filter_{{ field_name }}" 
                        style="width: 100%; padding: 10px; font-size: 13px; border: 2px solid #e8ecef; border-radius: 8px; background: white; cursor: pointer;"
                        onfocus="this.style.borderColor='#17a2b8'"
                        onblur="this.style.borderColor='#e8ecef'">
                    <option value="">All {{ field_config.label }}</option>
                    {% for option in field_config.options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; padding-top: 12px; border-top: 2px solid #e8ecef; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 12px;">
                <button onclick="performSearch()" 
                        class="btn btn-primary" 
                        style="padding: 12px 28px; font-size: 14px; font-weight: 600; border-radius: 6px; background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); border: none; box-shadow: 0 2px 8px rgba(23,162,184,0.3);">
                     Search
                </button>
                <button onclick="clearFilters()" 
                        class="btn btn-secondary" 
                        style="padding: 8px 20px; font-size: 14px; font-weight: 600; border-radius: 6px;">
                     Clear All
                </button>
            </div>
            
        </div>

        <!-- Search Results Summary -->
        <div id="searchResults" style="display: none; margin-top: 20px; padding: 16px 20px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left: 4px solid #28a745; border-radius: 6px;">
            <span id="resultsText" style="font-size: 14px; color: #155724; font-weight: 600;"></span>
            <button onclick="clearSearch()" style="float: right; background: none; border: none; color: #155724; cursor: pointer; font-weight: 600;"> Clear</button>
        </div>
    </div>
</div>
<!-- Quick Stats at the top (Admin only) -->
{% if session.role == 'admin' %}
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header" style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; padding: 12px 16px; border-radius: 6px 6px 0 0; border: none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: white;">Status Overview</h3>
        </div>
    </div>
    <div class="card-body">
        {% set counts = namespace(not_started=0, ongoing=0, completed=0, delayed=0) %}

        {% for pkg_id, pkg in packages.items() %}
            {% if pkg.data_timeline %}
                {% set latest_col = pkg.gantt_columns[-1] %}
                {% set latest_data = pkg.data_timeline[latest_col] %}
            {% else %}
                {% set latest_data = pkg.data %}
            {% endif %}
            
            {% set sow = latest_data.get('SOW', '') %}
            {% set sow_date = latest_data.get('SOW DATE', '') %}
            {% set actual_closure = latest_data.get('ACTUAL CLOSURE DATE', '') %}
            {% set commercial_target = latest_data.get('COMMERCIAL TARGET DATE', '') %}
            
            {# Completed takes priority #}
            {% if actual_closure %}
                {% set counts.completed = counts.completed + 1 %}
            
            {# Not started if no SOW #}
            {% elif not sow or sow|upper == 'NO' or not sow_date %}
                {% set counts.not_started = counts.not_started + 1 %}
            
            {# Check if delayed before marking as ongoing #}
            {% elif commercial_target %}
                {% set today = '2025-10-17' %}
                {% if commercial_target < today %}
                    {% set counts.delayed = counts.delayed + 1 %}
                {% else %}
                    {% set counts.ongoing = counts.ongoing + 1 %}
                {% endif %}
            
            {# Default to ongoing if has SOW but no target date #}
            {% else %}
                {% set counts.ongoing = counts.ongoing + 1 %}
            {% endif %}
        {% endfor %}
        
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #6c757d; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div class="stat-value" style="font-size: 32px; font-weight: 700; color: #2c3e50; margin-bottom: 8px;">{{ packages|length }}</div>
                <div class="stat-label" style="font-size: 12px; text-transform: uppercase; color: #6c757d; letter-spacing: 0.8px; font-weight: 600;">Total Packages</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #6c757d; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div class="stat-value" style="font-size: 32px; font-weight: 700; color: #6c757d; margin-bottom: 8px;">{{ counts.not_started }}</div>
                <div class="stat-label" style="font-size: 12px; text-transform: uppercase; color: #6c757d; letter-spacing: 0.8px; font-weight: 600;">Not Started</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div class="stat-value" style="font-size: 32px; font-weight: 700; color: #155724; margin-bottom: 8px;">{{ counts.ongoing }}</div>
                <div class="stat-label" style="font-size: 12px; text-transform: uppercase; color: #155724; letter-spacing: 0.8px; font-weight: 600;">Ongoing</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div class="stat-value" style="font-size: 32px; font-weight: 700; color: #0c5460; margin-bottom: 8px;">{{ counts.completed }}</div>
                <div class="stat-label" style="font-size: 12px; text-transform: uppercase; color: #0c5460; letter-spacing: 0.8px; font-weight: 600;">Completed</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div class="stat-value" style="font-size: 32px; font-weight: 700; color: #721c24; margin-bottom: 8px;">{{ counts.delayed }}</div>
                <div class="stat-label" style="font-size: 12px; text-transform: uppercase; color: #721c24; letter-spacing: 0.8px; font-weight: 600;">Delayed</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Packages Table -->
<div class="card" style="box-shadow: 0 4px 16px rgba(0,0,0,0.1); border: none; border-radius: 8px;">
    <div class="card-header" style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; padding: 18px 24px; border-radius: 8px 8px 0 0; border: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: white; letter-spacing: -0.3px;">Packages Dashboard</h2>
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <a href="{{ url_for('export_excel', filter_user=request.args.get('filter_user', 'all')) }}" 
                class="btn btn-primary" 
                style="font-size: 13px; padding: 10px 20px; font-weight: 600; border: 2px solid rgba(255,255,255,0.3); box-shadow: none; background: rgba(255,255,255,0.15); text-decoration: none; border-radius: 6px; transition: all 0.2s ease;">
                    Export Excel
                </a>
                {% if fresh_permissions.get('package_create', False) or session.role == 'admin' %}
                <a href="{{ url_for('create_package') }}" 
                class="btn btn-success" 
                style="font-size: 13px; padding: 10px 20px; font-weight: 600; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-decoration: none; border-radius: 6px; background: #28a745; transition: all 0.2s ease;">
                    Create Package
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- User Filter Section -->
    {% if session.role == 'admin' %}
    <div style="padding: 16px 24px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-bottom: 1px solid #e8ecef;">
        <form method="GET" action="{{ url_for('dashboard') }}" style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <label style="font-size: 14px; font-weight: 600; color: #2c3e50; margin: 0;">
                Filter by User:
            </label>
            <select name="filter_user" 
                    class="form-control" 
                    style="width: auto; min-width: 280px; padding: 10px 16px; font-size: 13px; border: 2px solid #e8ecef; border-radius: 6px; background: white; transition: all 0.2s ease;" 
                    onchange="this.form.submit()">
                <option value="all" {% if request.args.get('filter_user', 'all') == 'all' %}selected{% endif %}>
                    All Packages (All Users)
                </option>
                {% for username, user_data in users.items() %}
                    {% if username != 'admin' %}
                    <option value="{{ username }}" 
                            {% if request.args.get('filter_user') == username %}selected{% endif %}>
                        {{ user_data.name }} (@{{ username }})
                    </option>
                    {% endif %}
                {% endfor %}
            </select>
            {% if request.args.get('filter_user') and request.args.get('filter_user') != 'all' %}
            <a href="{{ url_for('dashboard') }}" 
            class="btn btn-secondary" 
            style="padding: 8px 16px; font-size: 12px; text-decoration: none; border-radius: 6px; background: #6c757d; color: white; transition: all 0.2s ease;">
                Clear Filter
            </a>
            <span style="font-size: 13px; color: #495057; margin-left: 8px; padding: 8px 16px; background: #e9ecef; border-radius: 6px; font-weight: 500;">
                Showing <strong style="color: #0066cc;">{{ packages|length }}</strong> package{{ 's' if packages|length != 1 else '' }} for: <strong style="color: #0066cc;">{{ users[request.args.get('filter_user')].name }}</strong>
            </span>
            {% endif %}
        </form>
    </div>
    {% endif %}

    <div class="card-body" style="padding: 0;">
        {% if packages %}
        <div class="table-container" style="overflow-x: auto; border-radius: 0 0 8px 8px;">
            <table class="table dashboard-table" style="margin-bottom: 0; border-collapse: separate; border-spacing: 0;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; background: #f8f9fa; z-index: 10;">Package ID</th>
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; background: #f8f9fa; z-index: 10;">Status</th>
                        {% for field_name, field_config in config.fields.items() %}
                        {% if field_name not in ['STATUS', 'status'] %}
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; background: #f8f9fa; z-index: 10;">{{ field_config.label }}</th>
                        {% endif %}
                        {% endfor %}
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; background: #f8f9fa; z-index: 10;">Assigned Users</th>
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; background: #f8f9fa; z-index: 10;">Created By</th>
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; background: #f8f9fa; z-index: 10;">Created</th>
                        <th style="padding: 16px 20px; font-size: 12px; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; position: sticky; right: 0; z-index: 15; background: #f8f9fa;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package_id, package in packages.items() %}
                    <tr style="border-bottom: 1px solid #e8ecef; transition: all 0.2s ease;" 
                        onmouseover="this.style.backgroundColor='#f0f7ff'; this.style.transform='translateX(2px)'" 
                        onmouseout="this.style.backgroundColor=''; this.style.transform=''">                   
                        <td style="padding: 18px 20px; vertical-align: middle; font-size: 13px;">
                            <strong style="color: #0066cc; font-weight: 600;">{{ package_id }}</strong>
                        </td> 
                        
                        <td style="padding: 18px 20px; vertical-align: middle;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if package.data_timeline %}
                                    {% set latest_column = package.gantt_columns[-1] %}
                                    {% set status_value = package.data_timeline[latest_column].get('STATUS', package.data_timeline[latest_column].get('status', '')).lower() %}
                                    {% set target_date = package.data_timeline[latest_column].get('COMMERCIAL TARGET DATE', '') %}
                                    {% set actual_closure = package.data_timeline[latest_column].get('ACTUAL CLOSURE DATE', '') %}
                                {% else %}
                                    {% set status_value = package.data.get('STATUS', package.data.get('status', '')).lower() %}
                                    {% set target_date = package.data.get('COMMERCIAL TARGET DATE', '') %}
                                    {% set actual_closure = package.data.get('ACTUAL CLOSURE DATE', '') %}
                                {% endif %}
                                
                                {# Calculate urgency #}
                                {% set today = '2025-10-14' %}
                                {% set is_overdue = false %}
                                {% set days_overdue = 0 %}
                                
                                {% if target_date and not actual_closure and status_value != 'completed' %}
                                    {% if target_date < today %}
                                        {% set is_overdue = true %}
                                        {# Calculate days - simplified for display #}
                                    {% endif %}
                                {% endif %}
                                
                                {# Urgency Indicator #}
                                {% if is_overdue %}
                                <div style="position: relative; display: inline-flex;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);" title="Overdue!">
                                        <span style="color: white; font-size: 14px; font-weight: 700;">!</span>
                                    </span>
                                </div>
                                {% elif target_date and not actual_closure %}
                                    {% set date_parts = target_date.split('-') %}
                                    {% set today_parts = today.split('-') %}
                                    {% if date_parts|length == 3 and today_parts|length == 3 %}
                                        {% set target_year = date_parts[0]|int %}
                                        {% set target_month = date_parts[1]|int %}
                                        {% set target_day = date_parts[2]|int %}
                                        {% set today_year = today_parts[0]|int %}
                                        {% set today_month = today_parts[1]|int %}
                                        {% set today_day = today_parts[2]|int %}
                                        
                                        {# Check if within 7 days #}
                                        {% if (target_year == today_year and target_month == today_month and target_day - today_day <= 7 and target_day - today_day > 0) %}
                                        <div style="position: relative; display: inline-flex;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); border-radius: 50%; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);" title="Due soon!">
                                                <span style="color: #856404; font-size: 14px; font-weight: 700;">⚠</span>
                                            </span>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                
                                {# Status Badge #}
                                {% if status_value %}
                                <span class="status-{{ status_value }}" style="padding: 6px 14px; border-radius: 16px; font-size: 11px; font-weight: 600; display: inline-block; letter-spacing: 0.3px;">
                                    {% if package.data_timeline %}
                                        {{ package.data_timeline[latest_column].get('STATUS', package.data_timeline[latest_column].get('status', '')) }}
                                    {% else %}
                                        {{ package.data.get('STATUS', package.data.get('status', '')) }}
                                    {% endif %}
                                </span>
                                {% else %}
                                <span style="color: #adb5bd; font-size: 13px; font-style: italic;">Not set</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Other fields -->
                        {% for field_name, field_config in config.fields.items() %}
                        {% if field_name not in ['STATUS', 'status'] %}
                        <td style="padding: 18px 20px; vertical-align: middle; font-size: 13px; color: #495057;">
                            {% if field_config.type == 'multiselect' %}
                                {% if package.data_timeline %}
                                    {% set latest_column = package.gantt_columns[-1] %}
                                    {% set field_value = package.data_timeline[latest_column].get(field_name, []) %}
                                {% else %}
                                    {% set field_value = package.data.get(field_name, []) %}
                                {% endif %}
                                {% if field_value %}
                                    <span style="color: #495057; font-weight: 500;">{{ field_value|join(', ') }}</span>
                                {% else %}
                                    <span style="color: #adb5bd; font-style: italic;">-</span>
                                {% endif %}
                            {% else %}
                                {% if package.data_timeline %}
                                    {% set latest_column = package.gantt_columns[-1] %}
                                    {% set field_value = package.data_timeline[latest_column].get(field_name, '') %}
                                {% else %}
                                    {% set field_value = package.data.get(field_name, '') %}
                                {% endif %}
                                {% if field_value %}
                                    <span style="color: #495057; font-weight: 500;">{{ field_value }}</span>
                                {% else %}
                                    <span style="color: #adb5bd; font-style: italic;">-</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                        
                        <td style="padding: 18px 20px; vertical-align: middle;">
                            <div class="user-badges" style="display: flex; flex-wrap: wrap; gap: 6px;">
                                {% for user in package.assigned_users %}
                                <span class="user-badge" style="background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #495057; border: 1px solid #dee2e6;">{{ user }}</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td style="padding: 18px 20px; vertical-align: middle; font-size: 13px; color: #6c757d;">{{ package.created_by }}</td>
                        <td style="padding: 18px 20px; vertical-align: middle; white-space: nowrap; font-size: 13px; color: #6c757d;">{{ package.created_at[:10] if package.created_at else '-' }}</td>
                        
                        <!-- Actions column -->
                        <td style="padding: 18px 20px; position: sticky; right: 0; z-index: 10; background: white; vertical-align: middle; box-shadow: -4px 0 8px rgba(0,0,0,0.05);">
                            {% set pkg_perms = package.user_permissions.get(session.username, {}) %}
                            {% set can_edit = fresh_role == 'admin' %}
                            {% set can_delete = fresh_role == 'admin' %}

                            {% if fresh_role != 'admin' %}
                                {% if pkg_perms and 'can_edit' in pkg_perms %}
                                    {% set can_edit = pkg_perms.can_edit %}
                                {% else %}
                                    {% set can_edit = fresh_permissions.get('package_update', False) %}
                                {% endif %}
                                
                                {% if pkg_perms and 'can_delete' in pkg_perms %}
                                    {% set can_delete = pkg_perms.can_delete %}
                                {% else %}
                                    {% set can_delete = fresh_permissions.get('package_delete', False) %}
                                {% endif %}
                            {% endif %}
                            
                            <div class="action-buttons" style="display: flex; gap: 8px; flex-wrap: nowrap;">
                                {% if can_edit and (fresh_role == 'admin' or session.username in package.assigned_users) %}
                                <a href="{{ url_for('edit_package', package_id=package_id) }}" 
                                class="btn btn-primary btn-sm" 
                                style="padding: 6px 14px; font-size: 12px; font-weight: 600; border-radius: 6px; text-decoration: none; white-space: nowrap; transition: all 0.2s ease;">
                                Edit
                                </a>
                                {% endif %}
                                
                                {% if can_delete %}
                                <a href="{{ url_for('delete_package', package_id=package_id) }}" 
                                class="btn btn-danger btn-sm"
                                style="padding: 6px 14px; font-size: 12px; font-weight: 600; border-radius: 6px; text-decoration: none; white-space: nowrap; transition: all 0.2s ease;"
                                onclick="return confirm('Delete this package?')">
                                Delete
                                </a>
                                {% endif %}
                                
                                {% if not can_edit and not can_delete %}
                                <span class="view-only-badge" style="color: #6c757d; font-size: 12px; font-weight: 500; padding: 6px 12px; background: #f8f9fa; border-radius: 6px; font-style: italic;">View Only</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="text-align: center; padding: 80px 40px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
            <div class="empty-state-icon" style="font-size: 72px; margin-bottom: 24px; opacity: 0.6; filter: grayscale(20%);">📦</div>
            <h3 style="font-size: 22px; font-weight: 600; color: #2c3e50; margin-bottom: 12px; letter-spacing: -0.3px;">No packages yet</h3>
            <p style="font-size: 15px; color: #6c757d; margin-bottom: 32px; line-height: 1.6;">
                {% if fresh_permissions.get('package_create', False) or session.role == 'admin' %}    
                Get started by creating your first package to begin tracking.
                {% else %}
                Contact an administrator to assign packages to you.
                {% endif %}
            </p>
            {% if fresh_permissions.get('package_create', False) or session.role == 'admin' %}
            <a href="{{ url_for('create_package') }}" 
            class="btn btn-success" 
            style="padding: 12px 32px; font-size: 15px; font-weight: 600; border-radius: 6px; text-decoration: none; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
            Create Your First Package
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
// ==================== DASHBOARD SEARCH & FILTER FUNCTIONALITY ====================

// Global variable to store all packages for filtering
let allPackages = {};

// Store initial package data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Capture all packages from the table
    const tableRows = document.querySelectorAll('.dashboard-table tbody tr');
    tableRows.forEach(row => {
        const packageId = row.cells[0].textContent.trim();
        
        // Extract all data from the row
        const rowData = {
            id: packageId,
            element: row,
            statusText: row.cells[1].textContent.trim().toLowerCase(),
            fields: {},
            assignedUsers: []
        };
        
        // Extract field data from all cells
        const fieldCells = row.querySelectorAll('td');
        fieldCells.forEach((cell, index) => {
            const text = cell.textContent.trim();
            rowData.fields[`field_${index}`] = text.toLowerCase();
        });
        
        // Extract assigned users
        const userBadges = row.querySelectorAll('.user-badge');
        userBadges.forEach(badge => {
            rowData.assignedUsers.push(badge.textContent.trim());
        });
        
        // Determine actual status based on the same logic as status overview
        rowData.actualStatus = determinePackageStatus(row);
        
        allPackages[packageId] = rowData;
    });
});

// Determine package status using the same logic as Status Overview
function determinePackageStatus(row) {
    // Get all field cells
    const cells = row.querySelectorAll('td');
    let sow = '';
    let sowDate = '';
    let actualClosure = '';
    let commercialTarget = '';
    
    // Extract field values by searching through cells
    cells.forEach(cell => {
        const text = cell.textContent.trim();
        const prevHeader = cell.cellIndex;
        
        // Try to identify fields by their position or content
        // This is a fallback - ideally we'd have data attributes
        if (cell.querySelector('input[type="date"]')) {
            const value = cell.querySelector('input[type="date"]')?.value || text;
            // Determine which date field this is based on context
        }
    });
    
    // Get data from the row's data attributes or visible content
    // We'll use a more robust approach: check the urgency indicator and status badge
    const statusBadge = row.querySelector('[class*="status-"]');
    const urgencyIndicator = row.querySelector('[style*="pulse"]') || row.querySelector('[title*="Overdue"]');
    const warningIndicator = row.querySelector('[title*="Due soon"]');
    
    // Priority logic matching the status overview:
    // 1. Check for completed (has actual closure date or status says completed)
    const hasCompletedStatus = statusBadge?.textContent.toLowerCase().includes('completed');
    if (hasCompletedStatus) {
        return 'completed';
    }
    
    // 2. Check for delayed (has urgency indicator with "!")
    if (urgencyIndicator) {
        return 'delayed';
    }
    
    // 3. Check for not started (no SOW or status indicates not started)
    const statusText = statusBadge?.textContent.toLowerCase() || '';
    if (statusText.includes('not') || statusText === '' || statusText === '-') {
        return 'not_started';
    }
    
    // 4. Check for cancelled
    if (statusText.includes('cancelled') || statusText.includes('cancel')) {
        return 'cancelled';
    }
    
    // 5. Default to ongoing if it has a status
    if (statusText.includes('ongoing') || statusText.includes('hold')) {
        return 'ongoing';
    }
    
    // Fallback: if has any status, consider it ongoing
    return statusText ? 'ongoing' : 'not_started';
}

// Main search function
function performSearch() {
    const searchText = document.getElementById('searchText').value.toLowerCase().trim();
    const statusFilter = Array.from(document.getElementById('statusFilter').selectedOptions).map(opt => opt.value);
    const userFilterElement = document.getElementById('userFilter');
    const userFilter = userFilterElement ? Array.from(userFilterElement.selectedOptions).map(opt => opt.value) : [];
    
    // Get custom field filters
    const customFilters = {};
    document.querySelectorAll('[id^="filter_"]').forEach(select => {
        if (select.value) {
            customFilters[select.id] = select.value.toLowerCase();
        }
    });
    
    let visibleCount = 0;
    let totalCount = 0;
    
    // Filter each package row
    Object.values(allPackages).forEach(pkg => {
        totalCount++;
        let isVisible = true;
        
        // Text search filter
        if (searchText) {
            const searchableText = [
                pkg.id,
                ...Object.values(pkg.fields),
                ...pkg.assignedUsers
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchText)) {
                isVisible = false;
            }
        }
        
        // Status filter - using the same logic as status overview
        if (statusFilter.length > 0 && isVisible) {
            // Use the pre-determined actual status
            if (!statusFilter.includes(pkg.actualStatus)) {
                isVisible = false;
            }
        }
        
        // User filter
        if (userFilter.length > 0 && isVisible) {
            const hasUser = userFilter.some(user => pkg.assignedUsers.includes(user));
            if (!hasUser) {
                isVisible = false;
            }
        }
        
        // Custom field filters
        if (Object.keys(customFilters).length > 0 && isVisible) {
            for (const [filterId, filterValue] of Object.entries(customFilters)) {
                const fieldFound = Object.values(pkg.fields).some(fieldValue => 
                    fieldValue.includes(filterValue)
                );
                if (!fieldFound) {
                    isVisible = false;
                    break;
                }
            }
        }
        
        // Show/hide row
        if (isVisible) {
            pkg.element.style.display = '';
            visibleCount++;
        } else {
            pkg.element.style.display = 'none';
        }
    });
    
    // Show results summary
    showSearchResults(visibleCount, totalCount);
    
    // Update status overview counts based on visible packages
    updateStatusCounts();
}

// Update status overview counts based on visible packages
function updateStatusCounts() {
    const counts = {
        not_started: 0,
        ongoing: 0,
        completed: 0,
        delayed: 0,
        total: 0
    };
    
    // Count visible packages by status
    Object.values(allPackages).forEach(pkg => {
        if (pkg.element.style.display !== 'none') {
            counts.total++;
            counts[pkg.actualStatus] = (counts[pkg.actualStatus] || 0) + 1;
        }
    });
    
    // Update the stat cards (only if they exist and search is active)
    const searchText = document.getElementById('searchText').value.trim();
    const statusFilter = document.getElementById('statusFilter').selectedOptions.length;
    const userFilterElement = document.getElementById('userFilter');
    const userFilter = userFilterElement ? userFilterElement.selectedOptions.length : 0;
    
    // Only update if filters are active
    if (searchText || statusFilter > 0 || userFilter > 0) {
        updateStatCard('Total Packages', counts.total);
        updateStatCard('Not Started', counts.not_started);
        updateStatCard('Ongoing', counts.ongoing);
        updateStatCard('Completed', counts.completed);
        updateStatCard('Delayed', counts.delayed);
    }
}

// Helper function to update individual stat cards
function updateStatCard(label, value) {
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        const labelElement = card.querySelector('.stat-label');
        if (labelElement && labelElement.textContent.includes(label)) {
            const valueElement = card.querySelector('.stat-value');
            if (valueElement) {
                // Store original value if not stored
                if (!valueElement.dataset.original) {
                    valueElement.dataset.original = valueElement.textContent;
                }
                valueElement.textContent = value;
                
                // Add visual indicator that it's filtered
                if (value !== parseInt(valueElement.dataset.original)) {
                    valueElement.style.color = '#0066cc';
                    valueElement.style.fontWeight = '800';
                } else {
                    valueElement.style.color = '';
                    valueElement.style.fontWeight = '';
                }
            }
        }
    });
}

// Reset status counts to original
function resetStatusCounts() {
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        const valueElement = card.querySelector('.stat-value');
        if (valueElement && valueElement.dataset.original) {
            valueElement.textContent = valueElement.dataset.original;
            valueElement.style.color = '';
            valueElement.style.fontWeight = '';
        }
    });
}

// Show search results summary
function showSearchResults(visibleCount, totalCount) {
    const resultsDiv = document.getElementById('searchResults');
    const resultsText = document.getElementById('resultsText');
    
    if (visibleCount < totalCount) {
        resultsText.textContent = `Showing ${visibleCount} of ${totalCount} packages`;
        resultsDiv.style.display = 'block';
    } else {
        resultsDiv.style.display = 'none';
    }
}

// Clear search results
function clearSearch() {
    // Show all rows
    Object.values(allPackages).forEach(pkg => {
        pkg.element.style.display = '';
    });
    
    // Hide results summary
    document.getElementById('searchResults').style.display = 'none';
    
    // Reset status counts
    resetStatusCounts();
}

// Clear all filters
function clearFilters() {
    // Clear text search
    document.getElementById('searchText').value = '';
    
    // Clear status filter
    const statusFilter = document.getElementById('statusFilter');
    Array.from(statusFilter.options).forEach(opt => opt.selected = false);
    
    // Clear user filter (if exists)
    const userFilterElement = document.getElementById('userFilter');
    if (userFilterElement) {
        Array.from(userFilterElement.options).forEach(opt => opt.selected = false);
    }
    
    // Clear custom field filters
    document.querySelectorAll('[id^="filter_"]').forEach(select => {
        select.value = '';
    });
    
    // Clear search and show all
    clearSearch();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('searchText').focus();
    }
    
    // Escape to clear search
    if (e.key === 'Escape') {
        const searchText = document.getElementById('searchText');
        if (document.activeElement === searchText) {
            clearFilters();
            searchText.blur();
        }
    }
});

// Auto-search on filter change
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all filter elements
    const filterElements = [
        'statusFilter',
        'userFilter'
    ];
    
    filterElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', performSearch);
        }
    });
    
    // Add listeners to custom field filters
    document.querySelectorAll('[id^="filter_"]').forEach(select => {
        select.addEventListener('change', performSearch);
    });
    
    // Real-time search as you type (debounced)
    let searchTimeout;
    const searchInput = document.getElementById('searchText');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300); // 300ms debounce
        });
    }
});
</script>
{% endblock %}